// Initialize Lucide icons
lucide.createIcons();

// DOM Elements
const playlistForm = document.getElementById('playlist-form');
const successMessage = document.getElementById('success-message');
const loadingOverlay = document.querySelector('.loading-overlay');
const visualizationImg = document.getElementById('visualization');

// Form submission handler
playlistForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const playlistUrl = document.getElementById('playlist-url').value;
    
    if (!isValidSpotifyUrl(playlistUrl)) {
        alert('Please enter a valid Spotify playlist URL');
        return;
    }

    loadingOverlay.classList.add('active');
    
    try {
        // Here you would typically make an API call to your backend
        await processPlaylist(playlistUrl);
        await loadVisualization();
        
        // Show success message
        successMessage.classList.remove('hidden');
        playlistForm.classList.add('hidden');
    } catch (error) {
        console.error('Error:', error);
        alert('There was an error processing your playlist. Please try again.');
    } finally {
        loadingOverlay.classList.remove('active');
    }
});

// Add another playlist button handler
document.getElementById('add-another').addEventListener('click', () => {
    successMessage.classList.add('hidden');
    playlistForm.classList.remove('hidden');
    document.getElementById('playlist-url').value = '';
});

// Utility Functions
async function loadVisualization() {
    try {
        const response = await fetch('/api/visualization');
        if (!response.ok) throw new Error('Failed to load visualization');
        const base64Data = await response.text();
        visualizationImg.src = `data:image/png;base64,${base64Data}`;
    } catch (error) {
        console.error('Error loading visualization:', error);
        throw error;
    }
}

function isValidSpotifyUrl(url) {
    return url.includes('spotify.com/playlist/');
}

async function processPlaylist(url) {
    // Simulate processing time - replace with actual API call
    await new Promise(resolve => setTimeout(resolve, 3000));
}

// Load visualization on page load
window.addEventListener('load', loadVisualization);
